<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Quiz â€” Realtime</title>
  <!-- Tailwind (CDN build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0b1020; --card: #131a33; --muted: #7b88a8; }
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: radial-gradient(1200px 600px at 20% -10%, #1a2550 0%, #0b1020 60%), #0b1020; color: #e9eefc; }
    .glass { background: rgba(19, 26, 51, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
    /* Replaced Tailwind @apply (not supported on CDN) with plain CSS */
    .btn { padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,.25); background: linear-gradient(180deg, #5da0ff, #457dff); color: white; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-ghost { padding: .5rem .75rem; border-radius: .75rem; font-size: .875rem; background: rgba(255,255,255,0.06); }
    .card { border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,.35); background: rgba(19, 26, 51, 0.7); border: 1px solid rgba(255,255,255,0.08); }
    @media (min-width: 768px) { .card { padding: 2rem; } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <!-- Firebase v9+ (Modular CDN) -->
  <!-- 1) Create a free Firebase project at https://console.firebase.google.com
       2) Add a Web App (no hosting needed), enable Anonymous Auth, and create a Realtime Database (Test Mode for events). 
       3) Paste your config in the CONFIG section below. Free tier is more than enough for big groups. -->
  <script type="module" id="firebase-sdk">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, update, get, child } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // === CONFIG â€” YOUR FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyB6GDeZ0euZvhJ1KvQE1LVt1N2Jv9RUxao",
      authDomain: "Ypoll-game-462fe.firebaseapp.com",
      databaseURL: "https://poll-game-462fe-default-rtdb.firebaseio.com",
      projectId: "poll-game-462fe",
      storageBucket: "poll-game-462fe.firebasestorage.app",
      messagingSenderId: "69278895023",
      appId: "1:69278895023:web:2e4c4dda3e3d5f706fbd5a"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Expose a tiny API for the non-module script below
    window.$fb = { db, auth, ref, set, onValue, update, get, child, signInAnonymously };
  </script>
  <!-- QRCode generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="min-h-full">
  <div id="app" class="max-w-6xl mx-auto px-4 py-6 md:py-10">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-white/10 grid place-items-center text-xl">ðŸ§­</div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Travel Quiz</h1>
      </div>
      <a class="btn-ghost" href="#howto">How it works</a>
    </header>

    <main id="screen" class="grid gap-6"></main>

    <footer class="mt-12 text-xs text-center text-slate-300/70">
      Built for big groups Â· Host & player views Â· Realtime leaderboard Â· Works on phones
    </footer>
  </div>

  <script>
  // ======= UTILS =======
  const $ = (sel, el = document) => el.querySelector(sel);
  const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const rand = (n) => Math.floor(Math.random()*n);
  const code = () => String(rand(9)+1) + String(rand(10)) + String(rand(10)) + String(rand(10)) + String(rand(10)) + String(rand(10));
  const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);

  // Sample Travel Qs
  const DEFAULT_QUESTIONS = [
    {
        "q": "What is the capital of Australia?",
        "options": ["Sydney", "Canberra", "Melbourne", "Perth"],
        "answer": 1
    },
    {
        "q": "Which country is known as the Land of the Rising Sun?",
        "options": ["China", "Thailand", "Japan", "South Korea"],
        "answer": 2
    },
    {
        "q": "Machu Picchu is located in which country?",
        "options": ["Peru", "Chile", "Mexico", "Brazil"],
        "answer": 0
    },
    {
        "q": "Which desert covers much of northern Africa?",
        "options": ["Gobi", "Sahara", "Kalahari", "Mojave"],
        "answer": 1
    },
    {
        "q": "What is the official language of Brazil?",
        "options": ["Spanish", "Portuguese", "French", "English"],
        "answer": 1
    },
    {
        "q": "Which European city is famous for its canals and gondolas?",
        "options": ["Amsterdam", "Venice", "Bruges", "Copenhagen"],
        "answer": 1
    },
    {
        "q": "Mount Kilimanjaro is located in which country?",
        "options": ["Kenya", "Tanzania", "Uganda", "Ethiopia"],
        "answer": 1
    },
    {
        "q": "Which country has the most islands in the world?",
        "options": ["Indonesia", "Sweden", "Philippines", "Norway"],
        "answer": 1
    },
    {
        "q": "What currency is used in Japan?",
        "options": ["Yuan", "Won", "Yen", "Ringgit"],
        "answer": 2
    },
    {
        "q": "Which US state is home to the Grand Canyon?",
        "options": ["Arizona", "Nevada", "Utah", "New Mexico"],
        "answer": 0
    },
    {
        "q": "Which city is known as the City of Love?",
        "options": ["Rome", "Venice", "Paris", "Vienna"],
        "answer": 2
    },
    {
        "q": "Which African country is famous for pyramids?",
        "options": ["Ethiopia", "Sudan", "Egypt", "Libya"],
        "answer": 2
    },
    {
        "q": "In which country would you find the city of Dubrovnik?",
        "options": ["Croatia", "Slovenia", "Montenegro", "Serbia"],
        "answer": 0
    },
    {
        "q": "Which Asian city has a famous Merlion statue?",
        "options": ["Bangkok", "Singapore", "Hong Kong", "Kuala Lumpur"],
        "answer": 1
    },
    {
        "q": "What is the tallest mountain in the world?",
        "options": ["K2", "Mount Everest", "Kangchenjunga", "Makalu"],
        "answer": 1
    },
    {
        "q": "Which country is home to the Great Barrier Reef?",
        "options": ["Fiji", "Australia", "New Zealand", "Indonesia"],
        "answer": 1
    },
    {
        "q": "Which European city is split by the River Danube?",
        "options": ["Budapest", "Vienna", "Bratislava", "Belgrade"],
        "answer": 0
    },
    {
        "q": "The Taj Mahal was built in which country?",
        "options": ["Pakistan", "India", "Bangladesh", "Nepal"],
        "answer": 1
    },
    {
        "q": "Which city is known as Big Apple?",
        "options": ["Chicago", "New York City", "Los Angeles", "Boston"],
        "answer": 1
    },
    {
        "q": "In which country can you visit the ancient city of Petra?",
        "options": ["Jordan", "Israel", "Turkey", "Lebanon"],
        "answer": 0
    },
    {
        "q": "Which country has the city of Marrakech?",
        "options": ["Algeria", "Tunisia", "Morocco", "Egypt"],
        "answer": 2
    },
    {
        "q": "Which European country is famous for waffles and chocolate?",
        "options": ["Switzerland", "Belgium", "France", "Netherlands"],
        "answer": 1
    },
    {
        "q": "The Great Wall of China was primarily built to protect against invasions from which direction?",
        "options": ["South", "West", "East", "North"],
        "answer": 3
    },
    {
        "q": "Which capital city is built on 14 islands?",
        "options": ["Stockholm", "Copenhagen", "Helsinki", "Oslo"],
        "answer": 0
    },
    {
        "q": "Which country is famous for Oktoberfest?",
        "options": ["Switzerland", "Austria", "Germany", "Poland"],
        "answer": 2
    },
    {
        "q": "Which city hosted the 2016 Summer Olympics?",
        "options": ["Rio de Janeiro", "Tokyo", "Beijing", "London"],
        "answer": 0
    },
    {
        "q": "What is the capital of Canada?",
        "options": ["Toronto", "Vancouver", "Montreal", "Ottawa"],
        "answer": 3
    },
    {
        "q": "In which country is the Angkor Wat temple complex?",
        "options": ["Cambodia", "Thailand", "Myanmar", "Vietnam"],
        "answer": 0
    },
    {
        "q": "Which mountain range separates Europe and Asia?",
        "options": ["Andes", "Ural", "Alps", "Caucasus"],
        "answer": 1
    },
    {
        "q": "Which desert is the largest hot desert in the world?",
        "options": ["Sahara", "Gobi", "Arabian", "Kalahari"],
        "answer": 0
    },
    {
        "q": "What is the currency of Mexico?",
        "options": ["Peso", "Real", "Dollar", "Colon"],
        "answer": 0
    },
    {
        "q": "Which country is shaped like a boot?",
        "options": ["Portugal", "Italy", "Spain", "Greece"],
        "answer": 1
    },
    {
        "q": "Which US state is closest to Russia?",
        "options": ["Alaska", "Hawaii", "Washington", "California"],
        "answer": 0
    },
    {
        "q": "Which sea separates Saudi Arabia from Africa?",
        "options": ["Red Sea", "Mediterranean", "Arabian Sea", "Caspian"],
        "answer": 0
    },
    {
        "q": "What is the capital of Thailand?",
        "options": ["Phuket", "Chiang Mai", "Bangkok", "Ayutthaya"],
        "answer": 2
    },
    {
        "q": "Which country has the maple leaf on its flag?",
        "options": ["Canada", "Denmark", "Switzerland", "Austria"],
        "answer": 0
    },
    {
        "q": "Which European country has a city called Bruges?",
        "options": ["Belgium", "Netherlands", "Germany", "Luxembourg"],
        "answer": 0
    },
    {
        "q": "Which continent is known as the birthplace of humanity?",
        "options": ["Asia", "Africa", "Europe", "South America"],
        "answer": 1
    },
    {
        "q": "Which Italian city is famous for its Leaning Tower?",
        "options": ["Florence", "Pisa", "Rome", "Venice"],
        "answer": 1
    },
    {
        "q": "Which river flows through Egypt?",
        "options": ["Amazon", "Yangtze", "Nile", "Danube"],
        "answer": 2
    },
    {
        "q": "Which Asian country was formerly known as Ceylon?",
        "options": ["Maldives", "Sri Lanka", "Myanmar", "Laos"],
        "answer": 1
    },
    {
        "q": "What is the capital of Iceland?",
        "options": ["Reykjavik", "Oslo", "Helsinki", "Copenhagen"],
        "answer": 0
    },
    {
        "q": "Which city has the famous Christ the Redeemer statue?",
        "options": ["Rio de Janeiro", "Lisbon", "Barcelona", "Buenos Aires"],
        "answer": 0
    },
    {
        "q": "Which country is famous for tulips and windmills?",
        "options": ["Netherlands", "Belgium", "Denmark", "Germany"],
        "answer": 0
    },
    {
        "q": "Which US city is known as the Windy City?",
        "options": ["New York", "Chicago", "Boston", "San Francisco"],
        "answer": 1
    },
    {
        "q": "Which Asian country is the largest by land area?",
        "options": ["China", "India", "Russia", "Kazakhstan"],
        "answer": 2
    },
    {
        "q": "Which city is home to the Colosseum?",
        "options": ["Athens", "Rome", "Istanbul", "Florence"],
        "answer": 1
    },
    {
        "q": "Which country is the smallest in the world by area?",
        "options": ["Monaco", "San Marino", "Vatican City", "Liechtenstein"],
        "answer": 2
    },
    {
        "q": "Which country is home to the Serengeti National Park?",
        "options": ["Kenya", "South Africa", "Tanzania", "Namibia"],
        "answer": 2
    },
    {
        "q": "Which city is famous for its Blue Mosque?",
        "options": ["Cairo", "Istanbul", "Tehran", "Damascus"],
        "answer": 1
    },
    {
        "q": "Which country has both the highest and lowest points on Earth?",
        "options": ["India", "Nepal", "China", "Pakistan"],
        "answer": 2
    },
    {
        "q": "What is the capital of Argentina?",
        "options": ["Buenos Aires", "Santiago", "Lima", "Montevideo"],
        "answer": 0
    },
    {
        "q": "Which Asian city is known as the Pearl of the Orient?",
        "options": ["Hong Kong", "Manila", "Shanghai", "Bangkok"],
        "answer": 1
    },
    {
        "q": "Which African country has Table Mountain?",
        "options": ["Kenya", "South Africa", "Namibia", "Zimbabwe"],
        "answer": 1
    },
    {
        "q": "Which is the worldâ€™s largest country by land area?",
        "options": ["Russia", "Canada", "China", "USA"],
        "answer": 0
    },
    {
        "q": "Which Middle Eastern city has the Burj Khalifa?",
        "options": ["Riyadh", "Abu Dhabi", "Doha", "Dubai"],
        "answer": 3
    },
    {
        "q": "Which sea is the lowest point on Earthâ€™s surface?",
        "options": ["Dead Sea", "Caspian Sea", "Black Sea", "Red Sea"],
        "answer": 0
    },
    {
        "q": "Which country is famous for the GalÃ¡pagos Islands?",
        "options": ["Peru", "Ecuador", "Chile", "Colombia"],
        "answer": 1
    },
    {
        "q": "Which desert covers much of Mongolia and northern China?",
        "options": ["Gobi", "Taklamakan", "Karakum", "Thar"],
        "answer": 0
    },
    {
        "q": "Which Asian country is home to the city of Varanasi?",
        "options": ["Nepal", "India", "Bangladesh", "Sri Lanka"],
        "answer": 1
    },
    {
        "q": "What is the capital of Spain?",
        "options": ["Barcelona", "Madrid", "Valencia", "Seville"],
        "answer": 1
    },
    {
        "q": "Which European country is home to Transylvania?",
        "options": ["Romania", "Hungary", "Bulgaria", "Serbia"],
        "answer": 0
    },
    {
        "q": "Which country is home to the Amazon rainforest?",
        "options": ["Brazil", "Peru", "Colombia", "Venezuela"],
        "answer": 0
    },
    {
        "q": "Which Asian city is home to Shibuya Crossing?",
        "options": ["Seoul", "Shanghai", "Tokyo", "Taipei"],
        "answer": 2
    },
    {
        "q": "Which city is home to the Acropolis?",
        "options": ["Athens", "Rome", "Istanbul", "Cairo"],
        "answer": 0
    },
    {
        "q": "Which country is famous for the city of Casablanca?",
        "options": ["Egypt", "Morocco", "Spain", "Tunisia"],
        "answer": 1
    },
    {
        "q": "Which European city has a famous Atomium building?",
        "options": ["Brussels", "Berlin", "Vienna", "Zurich"],
        "answer": 0
    },
    {
        "q": "Which island country is known as the Land Down Under?",
        "options": ["New Zealand", "Australia", "Fiji", "Papua New Guinea"],
        "answer": 1
    }
  ];

  

  // ======= GLOBAL STATE =======
  const S = {
    me: { uid: null, name: localStorage.getItem('tqp_name') || '' },
    role: null, // 'host' | 'player'
    room: null, // 6-digit
    questions: JSON.parse(localStorage.getItem('tqp_questions') || 'null') || DEFAULT_QUESTIONS,
    settings: JSON.parse(localStorage.getItem('tqp_settings') || 'null') || { perQuestionSec: 20, pointsCorrect: 100, pointsFastestBonus: 20, shuffle: true }
  };

  function saveLocal() {
    localStorage.setItem('tqp_questions', JSON.stringify(S.questions));
    localStorage.setItem('tqp_settings', JSON.stringify(S.settings));
    if (S.me.name) localStorage.setItem('tqp_name', S.me.name);
  }

  // ======= SCREENS =======
  const screen = document.getElementById('screen');

  const Screens = {
    home() {
      screen.innerHTML = `
        <section class="grid md:grid-cols-2 gap-6">
          <div class="card">
            <h2 class="text-xl font-bold mb-2">Host a Game</h2>
            <p class="text-sm text-slate-300/80 mb-4">Create a room, show the host view on a big screen, and let players join from their phones.</p>
            <div class="flex gap-2">
              <button id="btnHost" class="btn">Start Hosting</button>
              <button id="btnEdit" class="btn-ghost">Questions & settings</button>
            </div>
          </div>
          <div class="card">
            <h2 class="text-xl font-bold mb-2">Join a Game</h2>
            <p class="text-sm text-slate-300/80 mb-4">Enter a room code from your host to play on your device.</p>
            <div class="grid gap-3">
              <input id="joinCode" maxlength="6" placeholder="Room code (6 digits)" class="w-full bg-white/10 rounded-xl px-4 py-3 mono" />
              <input id="playerName" placeholder="Your name" class="w-full bg-white/10 rounded-xl px-4 py-3" />
              <button id="btnJoin" class="btn">Join Game</button>
            </div>
          </div>
        </section>

        <section id="howto" class="card">
          <h3 class="text-lg font-semibold mb-2">How it works</h3>
          <ol class="text-slate-300/90 text-sm grid gap-2 list-decimal pl-6">
            <li><b>Host:</b> click <i>Start Hosting</i> â†’ we create a 6â€‘digit room code.</li>
            <li><b>Players:</b> go to the same link on their phones and enter the room code + name.</li>
            <li>Hit <b>Start Round</b>. Each question is timed. Scores update instantly on the leaderboard.</li>
            <li>Fastest correct answer gets a small bonus â€” great for tiebreaks!</li>
            <li>You can edit/add travel questions or import JSON.</li>
          </ol>
          <p class="mt-3 text-xs text-slate-300/70">Tip: Share the host screen in a meeting or on a projector. This app uses Firebase Realtime Database (free tier). Paste your config at the top of this file.</p>
        </section>
      `;
      $('#btnHost').onclick = hostFlow;
      $('#btnEdit').onclick = editQuestions; // FIX: ensure function exists
      $('#btnJoin').onclick = () => joinFlow($('#joinCode').value.trim(), $('#playerName').value.trim());
      $('#playerName').value = S.me.name;
    },

    host(room) {
      screen.innerHTML = `
        <section class="card">
          <div class="flex items-center justify-between gap-4">
            <div>
              <div class="text-sm text-slate-300/80">Room code</div>
              <div class="text-4xl font-black mono tracking-widest">${room}</div>
              <div class="text-xs text-slate-300/70">Share this or the QR code with players</div>
            </div>
            <div class="grid gap-2 justify-items-end">
              <div id="qrcode" class="bg-white p-2 rounded-xl"></div>
              <div class="text-xs text-slate-300/70">Scan to join</div>
            </div>
          </div>
          <div class="mt-6 grid md:grid-cols-2 gap-6">
            <div class="glass rounded-3xl p-4">
              <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Round Controls</h3>
                <button class="btn-ghost text-xs" id="btnEditQs">Edit questions</button>
              </div>
              <div class="grid md:grid-cols-2 gap-3">
                <button id="btnStart" class="btn">Start Round</button>
                <button id="btnNext" class="btn-ghost">Next Question</button>
                <button id="btnEnd" class="btn-ghost">End Round</button>
                <button id="btnReset" class="btn-ghost">Reset Scores</button>
              </div>
              <div class="mt-3 text-xs text-slate-300/70">Each question: <b>${S.settings.perQuestionSec}s</b> Â· Correct: <b>${S.settings.pointsCorrect}</b> Â· Fastest bonus: <b>${S.settings.pointsFastestBonus}</b></div>
            </div>
            <div class="glass rounded-3xl p-4">
              <h3 class="font-semibold mb-2">Players</h3>
              <div id="players" class="text-sm grid gap-1"></div>
            </div>
          </div>
        </section>
        <section class="card mt-6">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Question</h3>
            <div class="text-sm text-slate-300/80">Time left: <span id="timeLeft">â€”</span>s</div>
          </div>
          <div id="questionBox" class="mt-2 text-lg"></div>
          <div id="optionsBox" class="grid md:grid-cols-2 gap-3 mt-4"></div>
        </section>
        <section class="card mt-6">
          <h3 class="font-semibold mb-2">Leaderboard</h3>
          <div id="leaderboard" class="grid gap-2"></div>
        </section>
      `;

      // QR to join
      const _url = window.location.href;
      const url = new URL(_url.split('?')[0]);
      url.searchParams.set('join', room);
      $('#qrcode').innerHTML = '';
      new QRCode($('#qrcode'), { text: url.toString(), width: 132, height: 132 });

      $('#btnEditQs').onclick = editQuestions; // FIX: ensure function exists
      $('#btnStart').onclick = () => startRound(room);
      $('#btnNext').onclick = () => nextQuestion(room);
      $('#btnEnd').onclick = () => endRound(room);
      $('#btnReset').onclick = () => resetScores(room);

      renderHostListeners(room);
    },

    player(room) {
      screen.innerHTML = `
        <section class="card">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xs text-slate-300/80">Room</div>
              <div class="text-2xl font-bold mono">${room}</div>
            </div>
            <div class="text-sm">Player: <b>${S.me.name}</b></div>
          </div>
        </section>
        <section class="card mt-6">
          <div id="pStatus" class="text-sm text-slate-300/80">Waiting for the host to start the roundâ€¦</div>
          <div id="pQuestion" class="mt-2 text-lg"></div>
          <div id="pOptions" class="grid gap-3 mt-3"></div>
          <div id="pFeedback" class="text-sm mt-3"></div>
        </section>
        <section class="card mt-6">
          <h3 class="font-semibold mb-2">Leaderboard</h3>
          <div id="pLeaderboard" class="grid gap-2"></div>
        </section>
      `;
      renderPlayerListeners(room);
    },

    edit() {
      screen.innerHTML = `
        <section class="card">
          <h2 class="text-xl font-bold mb-2">Questions & Settings</h2>
          <p class="text-sm text-slate-300/80">Edit questions below. Each question has <i>q</i>, <i>options</i> (4), and answer index <i>a</i>.</p>
          <textarea id="qs" class="w-full h-72 mt-3 bg-white/10 rounded-xl p-3 text-xs">${JSON.stringify(S.questions, null, 2)}</textarea>
          <div class="grid md:grid-cols-4 gap-3 mt-3 items-end">
            <label class="grid gap-1 text-sm">Per-question seconds<input id="setSec" type="number" min="5" max="120" value="${S.settings.perQuestionSec}" class="bg-white/10 rounded-xl px-3 py-2"></label>
            <label class="grid gap-1 text-sm">Points correct<input id="setPts" type="number" min="10" max="1000" value="${S.settings.pointsCorrect}" class="bg-white/10 rounded-xl px-3 py-2"></label>
            <label class="grid gap-1 text-sm">Fastest bonus<input id="setBonus" type="number" min="0" max="200" value="${S.settings.pointsFastestBonus}" class="bg-white/10 rounded-xl px-3 py-2"></label>
            <label class="flex gap-2 items-center text-sm mt-4 md:mt-0"><input id="setShuffle" type="checkbox" ${S.settings.shuffle? 'checked': ''}> Shuffle questions</label>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="saveQs" class="btn">Save</button>
            <button id="cancelQs" class="btn-ghost">Back</button>
          </div>
        </section>
      `;
      $('#saveQs').onclick = () => {
        try {
          const parsed = JSON.parse($('#qs').value);
          if (!Array.isArray(parsed)) throw new Error('Questions must be an array');
          S.questions = parsed;
          S.settings.perQuestionSec = parseInt($('#setSec').value);
          S.settings.pointsCorrect = parseInt($('#setPts').value);
          S.settings.pointsFastestBonus = parseInt($('#setBonus').value);
          S.settings.shuffle = $('#setShuffle').checked;
          saveLocal();
          Screens.home();
        } catch (e) { alert('Could not save: ' + e.message); }
      };
      $('#cancelQs').onclick = Screens.home;
    }
  };

  // Provide the previously-missing function used by buttons
  function editQuestions() { Screens.edit(); }

  // ======= FIREBASE HELPERS =======
  async function ensureAuth() {
    const { auth, signInAnonymously } = window.$fb;
    if (!auth.currentUser) await signInAnonymously(auth).catch(err => alert('Auth error: ' + err.message));
    return auth.currentUser;
  }

  function roomRef(room) { return window.$fb.ref(window.$fb.db, `rooms/${room}`); }
  function playersRef(room) { return window.$fb.ref(window.$fb.db, `rooms/${room}/players`); }
  function stateRef(room) { return window.$fb.ref(window.$fb.db, `rooms/${room}/state`); }

  async function hostFlow() {
    await ensureAuth();
    S.role = 'host';
    S.room = code();
    // Create room skeleton
    await window.$fb.set(roomRef(S.room), {
      createdAt: Date.now(),
      settings: S.settings,
      questions: S.questions,
      state: { status: 'lobby', qIndex: -1, endAt: 0 }
    });
    Screens.host(S.room);
    history.replaceState({}, '', location.pathname + `?host=${S.room}`);
  }

  async function joinFlow(room, name) {
    room = String(room || '').replace(/\D/g, '').slice(0,6);
    if (!room) return alert('Enter a valid 6-digit room code');
    name = name || prompt('Your display name');
    if (!name) return;

    await ensureAuth();
    S.me.uid = window.$fb.auth.currentUser.uid;
    S.me.name = name.trim().slice(0,18);
    S.role = 'player';
    S.room = room;

    // Register player
    await window.$fb.update(playersRef(room), { [S.me.uid]: { name: S.me.name, score: 0, joinedAt: Date.now() }});
    Screens.player(room);
    saveLocal();
    history.replaceState({}, '', location.pathname + `?join=${room}`);
  }

  async function startRound(room) {
    await window.$fb.update(stateRef(room), { status: 'running', qIndex: -1, endAt: 0, fastestAwarded: false });
    await nextQuestion(room);
  }

  async function nextQuestion(room) {
    const game = await window.$fb.get(roomRef(room));
    const data = game.val();
    const total = (data.questions || []).length;
    let i = (data.state?.qIndex ?? -1) + 1;
    if (S.settings.shuffle && i === 0) {
      const shuf = shuffle(data.questions);
      await window.$fb.update(roomRef(room), { questions: shuf });
    }
    if (i >= total) { await endRound(room); return; }
    const endAt = Date.now() + (S.settings.perQuestionSec * 1000);
    await window.$fb.update(stateRef(room), { status: 'question', qIndex: i, endAt, fastestAwarded: false });
    // clear lastAnswer flags
    const playersSnap = await window.$fb.get(playersRef(room));
    const players = playersSnap.val() || {};
    const cleared = {};
    Object.keys(players).forEach(uid => { cleared[uid] = { ...players[uid], lastAnswer: null, lastCorrect: null, lastTs: null }; });
    await window.$fb.set(playersRef(room), cleared);
  }

  async function endRound(room) { await window.$fb.update(stateRef(room), { status: 'ended' }); }
  async function resetScores(room) {
    const playersSnap = await window.$fb.get(playersRef(room));
    const players = playersSnap.val() || {};
    const reset = {};
    Object.keys(players).forEach(uid => { reset[uid] = { ...players[uid], score: 0, lastAnswer: null, lastCorrect: null, lastTs: null }; });
    await window.$fb.set(playersRef(room), reset);
  }

  // Player submit
  async function submitAnswer(room, idx) {
    const gameSnap = await window.$fb.get(roomRef(room));
    const g = gameSnap.val();
    const q = g.questions[g.state.qIndex];
    const correct = idx === q.a;
    const now = Date.now();

    // If already answered, ignore
    const pSnap = await window.$fb.get(window.$fb.ref(window.$fb.db, `rooms/${room}/players/${S.me.uid}`));
    const me = pSnap.val();
    if (me?.lastTs && me.lastTs > (g.state.endAt - S.settings.perQuestionSec * 1000)) return; // already answered this round

    // Update my answer
    await window.$fb.update(window.$fb.ref(window.$fb.db, `rooms/${room}/players/${S.me.uid}`), { lastAnswer: idx, lastCorrect: correct, lastTs: now });

    // Scoring: correct => +points; fastest bonus once per question
    if (correct) {
      let bonus = 0;
      if (!g.state.fastestAwarded) {
        bonus = S.settings.pointsFastestBonus;
        await window.$fb.update(stateRef(room), { fastestAwarded: true });
      }
      const add = S.settings.pointsCorrect + bonus;
      await window.$fb.update(window.$fb.ref(window.$fb.db, `rooms/${room}/players/${S.me.uid}`), { score: (me?.score||0) + add });
    }
  }

  // ======= RUNTIME LISTENERS =======
  function renderLeaderboard(el, players) {
    const items = Object.values(players||{}).map(p => ({ name: p.name, score: p.score||0, lastTs: p.lastTs||0, lastCorrect: !!p.lastCorrect }));
    items.sort((a,b) => b.score - a.score || a.lastTs - b.lastTs);
    el.innerHTML = items.map((p,i) => `
      <div class="flex items-center justify-between rounded-2xl px-3 py-2 ${i===0? 'bg-white/10':''}">
        <div class="flex items-center gap-3">
          <div class="w-6 text-center mono">${i+1}</div>
          <div class="font-semibold">${p.name}</div>
          ${p.lastCorrect ? '<span class="text-xs bg-green-500/20 rounded px-2 py-0.5">âœ” last correct</span>' : ''}
        </div>
        <div class="mono">${p.score}</div>
      </div>
    `).join('');
  }

  function renderOptions(el, q, disabled, onClick) {
    el.innerHTML = '';
    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'px-4 py-3 rounded-2xl text-left bg-white/10 hover:bg-white/20 disabled:opacity-50';
      btn.textContent = opt;
      btn.disabled = !!disabled;
      btn.onclick = () => onClick(i);
      el.appendChild(btn);
    });
  }

  function renderHostListeners(room) {
    // Players list
    window.$fb.onValue(playersRef(room), snap => {
      const players = snap.val() || {};
      const el = $('#players');
      el.innerHTML = Object.values(players).map(p => `<div class="flex items-center justify-between bg-white/5 rounded-xl px-3 py-2"><div>${p.name}</div><div class="mono text-sm text-slate-300/80">${p.score||0}</div></div>`).join('');
      renderLeaderboard($('#leaderboard'), players);
    });

    // Question/timer
    let timerInt = null;
    window.$fb.onValue(stateRef(room), async snap => {
      const st = snap.val();
      if (!st) return;
      const roomSnap = await window.$fb.get(roomRef(room));
      const g = roomSnap.val();

      if (st.status === 'question') {
        const q = g.questions[st.qIndex];
        $('#questionBox').textContent = q.q;
        renderOptions($('#optionsBox'), q, true, () => {}); // host view disabled
        // Timer
        clearInterval(timerInt);
        timerInt = setInterval(async () => {
          const left = Math.max(0, Math.ceil((st.endAt - Date.now())/1000));
          $('#timeLeft').textContent = left;
          if (left <= 0) {
            clearInterval(timerInt);
            // Show correct answer highlight briefly
            const opts = $$('#optionsBox button');
            opts.forEach((b, i) => { if (i === q.a) b.classList.add('outline','outline-2','outline-green-500/60'); });
            await sleep(1500);
            nextQuestion(room);
          }
        }, 200);
      } else if (st.status === 'ended') {
        clearInterval(timerInt);
        $('#timeLeft').textContent = 'â€”';
        $('#questionBox').textContent = 'Round ended';
        $('#optionsBox').innerHTML = '';
      } else if (st.status === 'lobby') {
        $('#questionBox').textContent = 'Waiting to startâ€¦';
        $('#optionsBox').innerHTML = '';
      }
    });
  }

  function renderPlayerListeners(room) {
    // Leaderboard
    window.$fb.onValue(playersRef(room), snap => renderLeaderboard($('#pLeaderboard'), snap.val() || {}));

    // Question flow
    let ticking = null;
    window.$fb.onValue(stateRef(room), async snap => {
      const st = snap.val();
      if (!st) return;
      const g = (await window.$fb.get(roomRef(room))).val();

      if (st.status === 'question') {
        const q = g.questions[st.qIndex];
        $('#pStatus').textContent = `Answer fast! ${S.settings.pointsCorrect} pts + ${S.settings.pointsFastestBonus} bonus for fastest correct.`;
        $('#pQuestion').textContent = q.q;
        let answered = false;
        renderOptions($('#pOptions'), q, false, async (idx) => {
          if (answered) return; answered = true;
          await submitAnswer(room, idx);
          $('#pFeedback').textContent = 'Answer received!';
          // Lock UI
          renderOptions($('#pOptions'), q, true, () => {});
        });
        clearInterval(ticking);
        ticking = setInterval(() => {
          const left = Math.max(0, Math.ceil((st.endAt - Date.now())/1000));
          if (left <= 0) { clearInterval(ticking); $('#pStatus').textContent = 'Time!'; }
        }, 200);
      } else if (st.status === 'ended') {
        $('#pStatus').textContent = 'Round ended. Ask the host to start a new round!';
        $('#pQuestion').textContent = '';
        $('#pOptions').innerHTML = '';
      } else if (st.status === 'lobby') {
        $('#pStatus').textContent = 'Waiting for host to startâ€¦';
        $('#pQuestion').textContent = '';
        $('#pOptions').innerHTML = '';
      }
    });
  }

  // ======= ROUTER =======
  async function init() {
    const params = new URLSearchParams(location.search);
    const hostCode = params.get('host');
    const joinCode = params.get('join');

    if (hostCode) {
      S.role = 'host'; S.room = hostCode; Screens.host(hostCode);
    } else if (joinCode) {
      if (!S.me.name) {
        const n = prompt('Enter your name'); if (!n) { Screens.home(); return; } S.me.name = n; saveLocal();
      }
      joinFlow(joinCode, S.me.name);
    } else {
      Screens.home();
    }

    // Optionally run tests with ?test=1 (non-invasive)
    if (params.get('test') === '1') {
      setTimeout(runTests, 30);
    }
  }

  window.addEventListener('load', init);

  // ======= LIGHT TESTS (opt-in via ?test=1) =======
  function runTests() {
    const results = [];
    const push = (name, pass, err='') => results.push({ name, pass, err });
    const assert = (cond, msg) => { if (!cond) throw new Error(msg); };

    try { assert(typeof editQuestions === 'function', 'editQuestions should be defined'); push('editQuestions exists', true); } catch(e){ push('editQuestions exists', false, e.message); }

    try {
      const c = code();
      assert(/^[1-9][0-9]{5}$/.test(c), 'code() should be 6 digits, no leading 0');
      push('room code format', true);
    } catch(e) { push('room code format', false, e.message); }

    try {
      const arr = [1,2,3,4,5];
      const sh = shuffle(arr);
      assert(arr.length === sh.length, 'shuffle length mismatch');
      assert(arr.every(v => sh.includes(v)), 'shuffle lost element');
      push('shuffle preserves elements', true);
    } catch(e) { push('shuffle preserves elements', false, e.message); }

    try {
      const el = document.createElement('div');
      renderOptions(el, { options: ['A','B','C','D'] }, false, () => {});
      assert(el.children.length === 4, 'renderOptions should render 4 buttons');
      push('renderOptions count', true);
    } catch(e) { push('renderOptions count', false, e.message); }

    try {
      const el = document.createElement('div');
      const players = {
        a: { name:'Ann', score:120, lastTs: 5, lastCorrect:true },
        b: { name:'Bob', score:200, lastTs: 3, lastCorrect:false },
        c: { name:'Cat', score:120, lastTs: 2, lastCorrect:false }
      };
      renderLeaderboard(el, players);
      const first = el.querySelector('.font-semibold')?.textContent;
      assert(first === 'Bob', 'Leaderboard should place highest score first');
      push('leaderboard sorting', true);
    } catch(e) { push('leaderboard sorting', false, e.message); }

    // UI output
    const panel = document.createElement('div');
    panel.className = 'fixed bottom-4 right-4 max-w-sm p-4 rounded-2xl glass text-sm';
    panel.innerHTML = `<div class="font-semibold mb-1">Self-tests</div>` +
      results.map(r => `<div class="flex items-start gap-2 ${r.pass? 'text-green-400':'text-red-400'}">
        <div>${r.pass? 'âœ”':'âœ–'}</div>
        <div>${r.name}${r.pass? '': ` â€” ${r.err}`}</div>
      </div>`).join('');
    document.body.appendChild(panel);

    console.table(results);
  }
  </script>
</body>
</html>
